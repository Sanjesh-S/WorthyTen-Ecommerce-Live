<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin - Manage Product Variants | WorthyTen</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .variant-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .variant-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .variant-header h1 {
            font-size: 2rem;
            font-weight: 800;
            color: #111;
            margin-bottom: 10px;
        }

        .search-section {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-section input,
        .search-section select {
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            flex: 1;
            min-width: 200px;
        }

        .search-section button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        .product-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: start;
        }

        .product-card img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 8px;
            background: #f5f5f7;
        }

        .product-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .product-info .meta {
            color: #666;
            font-size: 0.9rem;
        }

        .variants-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .variant-chip {
            background: #e0e7ff;
            color: #4338ca;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .variant-chip .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .variant-chip .remove:hover {
            opacity: 1;
        }

        .add-variant-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .add-variant-form input,
        .add-variant-form select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .add-variant-form button {
            padding: 8px 16px;
            background: #10b981;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .bulk-section {
            background: #f9fafb;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .bulk-section h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .preset-btn {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #e0e7ff;
            border-color: #667eea;
        }

        .preset-btn.selected {
            background: #667eea;
            color: #fff;
            border-color: #667eea;
        }

        .log-box {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 16px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            color: #4ade80;
            margin-top: 20px;
        }

        .log-entry {
            padding: 2px 0;
        }

        .log-entry.error {
            color: #f87171;
        }

        .log-entry.info {
            color: #60a5fa;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .login-required {
            text-align: center;
            padding: 60px 20px;
        }

        @media (max-width: 768px) {
            .product-card {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="variant-container">
        <div class="variant-header">
            <h1>üì± Manage Product Variants</h1>
            <p>Add combined RAM/Storage variants like "8GB/128GB" to products</p>
        </div>

        <!-- Login Required -->
        <div id="login-section" class="login-required">
            <h2>üîê Admin Login Required</h2>
            <p>Please login with your admin account.</p>
            <a href="admin-login.html" class="search-section button"
                style="display: inline-block; padding: 14px 28px; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border-radius: 12px; text-decoration: none; font-weight: 700;">Go
                to Admin Login</a>
        </div>

        <!-- Main Content -->
        <div id="main-section" style="display: none;">

            <!-- Bulk Presets -->
            <div class="bulk-section">
                <h3>üì¶ Quick Variant Presets</h3>
                <p style="margin-bottom: 12px; color: #666;">Click to copy preset variants for common phones:</p>
                <div class="presets">
                    <button class="preset-btn" data-preset="iphone16plus">iPhone 16 Plus</button>
                    <button class="preset-btn" data-preset="iphone16">iPhone 16</button>
                    <button class="preset-btn" data-preset="iphone15pro">iPhone 15 Pro</button>
                    <button class="preset-btn" data-preset="s24ultra">Galaxy S24 Ultra</button>
                    <button class="preset-btn" data-preset="zflip5">Galaxy Z Flip 5</button>
                    <button class="preset-btn" data-preset="zfold5">Galaxy Z Fold 5</button>
                </div>
                <div id="preset-preview"
                    style="display: none; margin-top: 12px; padding: 12px; background: #fff; border-radius: 8px;">
                    <strong>Variants:</strong> <span id="preset-variants"></span>
                </div>
            </div>

            <!-- Search -->
            <div class="search-section">
                <select id="category-filter">
                    <option value="">All Categories</option>
                    <option value="Phone">Phone</option>
                    <option value="Laptop">Laptop</option>
                    <option value="iPad">iPad</option>
                </select>
                <select id="brand-filter">
                    <option value="">All Brands</option>
                </select>
                <input type="text" id="search-input" placeholder="Search products...">
                <button id="search-btn"><i class="fa-solid fa-search"></i> Search</button>
            </div>

            <!-- Products List -->
            <div id="products-list">
                <div class="empty-state">
                    <i class="fa-solid fa-box-open" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p>Select a category or search for products</p>
                </div>
            </div>

            <!-- Log -->
            <div class="log-box" id="log-box">
                <div class="log-entry info">Ready. Search for products to manage variants.</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        const logBox = document.getElementById('log-box');
        const productsList = document.getElementById('products-list');
        const categoryFilter = document.getElementById('category-filter');
        const brandFilter = document.getElementById('brand-filter');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        // Preset variants for common phones
        const presets = {
            iphone16plus: ['8GB/128GB', '8GB/256GB', '8GB/512GB'],
            iphone16: ['8GB/128GB', '8GB/256GB', '8GB/512GB'],
            iphone15pro: ['8GB/128GB', '8GB/256GB', '8GB/512GB', '8GB/1TB'],
            s24ultra: ['12GB/256GB', '12GB/512GB', '12GB/1TB'],
            zflip5: ['8GB/256GB', '8GB/512GB'],
            zfold5: ['12GB/256GB', '12GB/512GB', '12GB/1TB']
        };

        function log(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // Load products from Firebase
        async function loadProducts() {
            const db = firebase.firestore();
            const category = categoryFilter.value;
            const brand = brandFilter.value;
            const search = searchInput.value.toLowerCase();

            log('Loading products...', 'info');
            productsList.innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';

            try {
                let query = db.collection('products');

                if (category) {
                    query = query.where('category', '==', category);
                }
                if (brand) {
                    query = query.where('brand', '==', brand);
                }

                const snapshot = await query.limit(50).get();
                const products = [];
                const brands = new Set();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    brands.add(data.brand);

                    if (search && !data.name?.toLowerCase().includes(search)) {
                        return;
                    }

                    products.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Update brand filter
                if (!brand) {
                    brandFilter.innerHTML = '<option value="">All Brands</option>';
                    [...brands].sort().forEach(b => {
                        if (b) brandFilter.innerHTML += `<option value="${b}">${b}</option>`;
                    });
                }

                renderProducts(products);
                log(`Loaded ${products.length} products`, 'info');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                productsList.innerHTML = `<div class="empty-state">Error loading products</div>`;
            }
        }

        // Render products list
        function renderProducts(products) {
            if (products.length === 0) {
                productsList.innerHTML = '<div class="empty-state">No products found</div>';
                return;
            }

            productsList.innerHTML = '';
            products.forEach(product => {
                const variants = product.variants || [];
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
          <img src="${product.image || 'images/placeholder.png'}" alt="${product.name}" onerror="this.src='images/placeholder.png'">
          <div class="product-info">
            <h3>${product.name}</h3>
            <div class="meta">${product.brand} ‚Ä¢ ${product.category} ‚Ä¢ ‚Çπ${(product.price || 0).toLocaleString('en-IN')}</div>
            <div class="variants-section" id="variants-${product.id}">
              ${variants.map(v => `
                <span class="variant-chip">
                  ${v}
                  <span class="remove" onclick="removeVariant('${product.id}', '${v}')">&times;</span>
                </span>
              `).join('')}
              ${variants.length === 0 ? '<span style="color: #999; font-size: 0.85rem;">No variants set</span>' : ''}
            </div>
            <div class="add-variant-form">
              <input type="text" placeholder="e.g., 8GB/128GB" id="new-variant-${product.id}" style="width: 120px;">
              <button onclick="addVariant('${product.id}')">+ Add</button>
              <select onchange="applyPreset('${product.id}', this.value)" style="width: auto;">
                <option value="">Apply Preset...</option>
                <option value="iphone16plus">iPhone 16 Plus</option>
                <option value="iphone16">iPhone 16</option>
                <option value="iphone15pro">iPhone 15 Pro</option>
                <option value="s24ultra">Galaxy S24 Ultra</option>
                <option value="zflip5">Galaxy Z Flip 5</option>
                <option value="zfold5">Galaxy Z Fold 5</option>
              </select>
            </div>
          </div>
          <div>
            <small style="color: #999;">${product.id.substring(0, 8)}...</small>
          </div>
        `;
                productsList.appendChild(card);
            });
        }

        // Add variant to product
        async function addVariant(productId) {
            const input = document.getElementById(`new-variant-${productId}`);
            const variant = input.value.trim();

            if (!variant) {
                alert('Please enter a variant (e.g., 8GB/128GB)');
                return;
            }

            const db = firebase.firestore();
            try {
                const docRef = db.collection('products').doc(productId);
                const doc = await docRef.get();
                const variants = doc.data()?.variants || [];

                if (!variants.includes(variant)) {
                    variants.push(variant);
                    await docRef.update({ variants });
                    log(`Added variant "${variant}" to product`, 'info');
                }

                input.value = '';
                loadProducts();
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Remove variant from product
        async function removeVariant(productId, variant) {
            if (!confirm(`Remove variant "${variant}"?`)) return;

            const db = firebase.firestore();
            try {
                const docRef = db.collection('products').doc(productId);
                const doc = await docRef.get();
                let variants = doc.data()?.variants || [];

                variants = variants.filter(v => v !== variant);
                await docRef.update({ variants });

                log(`Removed variant "${variant}"`, 'info');
                loadProducts();
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Apply preset variants
        async function applyPreset(productId, presetName) {
            if (!presetName) return;

            const presetVariants = presets[presetName];
            if (!presetVariants) return;

            if (!confirm(`Apply ${presetVariants.length} variants: ${presetVariants.join(', ')}?`)) {
                return;
            }

            const db = firebase.firestore();
            try {
                await db.collection('products').doc(productId).update({
                    variants: presetVariants
                });
                log(`Applied preset "${presetName}" variants`, 'info');
                loadProducts();
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Preset preview
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const preset = btn.dataset.preset;
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                const variants = presets[preset];
                document.getElementById('preset-preview').style.display = 'block';
                document.getElementById('preset-variants').textContent = variants.join(', ');
            });
        });

        // Event listeners
        searchBtn.addEventListener('click', loadProducts);
        categoryFilter.addEventListener('change', loadProducts);
        brandFilter.addEventListener('change', loadProducts);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadProducts();
        });

        // Auth check
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const db = firebase.firestore();
                    const staffDoc = await db.collection('staffUsers').doc(user.uid).get();

                    if (staffDoc.exists && staffDoc.data().isActive) {
                        document.getElementById('login-section').style.display = 'none';
                        document.getElementById('main-section').style.display = 'block';
                        log(`Logged in as: ${user.email || user.phoneNumber}`, 'info');
                    }
                } catch (error) {
                    log(`Auth error: ${error.message}`, 'error');
                }
            }
        });
    </script>
</body>

</html>